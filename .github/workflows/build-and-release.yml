name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  FORCE_COLOR: 0
  ELECTRON_CACHE: ${{ github.workspace }}/.cache/electron
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder

jobs:
  build-and-release:
    runs-on: windows-latest
    
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Get version from tag
      id: get_version
      run: |
        $VERSION = "${{ github.ref_name }}" -replace '^v', ''
        echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
        echo "RELEASE_NAME=QLinkNote v$VERSION" >> $env:GITHUB_OUTPUT
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Build Electron app
      run: npm run electron:pack
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
        WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
        
    - name: List release files
      run: |
        echo "æ‰“åŒ…ç»“æœ:"
        Get-ChildItem -Path "release" -Recurse -File | Select-Object FullName, Length | Format-Table
      
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: ${{ steps.get_version.outputs.RELEASE_NAME }}
        body: |
          ğŸ‰ QLinkNote æ–°ç‰ˆæœ¬å‘å¸ƒï¼
          
          ## ğŸ“¦ ä¸‹è½½åœ°å€
          
          ### Windows ç”¨æˆ·
          - **å®‰è£…ç‰ˆ**: ä¸‹è½½ `QLinkNote-Setup-${{ steps.get_version.outputs.VERSION }}.exe`
          - **ä¾¿æºç‰ˆ**: ä¸‹è½½å¹¶è§£å‹ `QLinkNote-win-x64-${{ steps.get_version.outputs.VERSION }}.zip`
          - **Microsoft Store ç‰ˆæœ¬**: ä¸‹è½½ `QLinkNote-${{ steps.get_version.outputs.VERSION }}.appx`
          
          ## ğŸš€ ä¸»è¦ç‰¹æ€§
          - ğŸ“ å®æ—¶ Markdown ç¼–è¾‘å’Œé¢„è§ˆ
          - ğŸ“ å®Œæ•´çš„æ–‡ä»¶ç®¡ç†ç³»ç»Ÿ
          - ğŸ” å¼ºå¤§çš„å…¨æ–‡æœç´¢åŠŸèƒ½
          - ğŸŒ“ æ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢
          - âš¡ ä¸°å¯Œçš„é”®ç›˜å¿«æ·é”®
          - ğŸ’¾ è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
          - ğŸ—ºï¸ å…³ç³»å›¾è°±å¯è§†åŒ–
          
          ## ğŸ“‹ å®‰è£…è¯´æ˜
          
          ### å®‰è£…ç‰ˆ (exe)
          1. ä¸‹è½½ `QLinkNote-Setup-${{ steps.get_version.outputs.VERSION }}.exe`
          2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
          3. æŒ‰ç…§å‘å¯¼å®Œæˆå®‰è£…
          
          ### ä¾¿æºç‰ˆ (zip)
          1. ä¸‹è½½ `QLinkNote-win-x64-${{ steps.get_version.outputs.VERSION }}.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡» `QLinkNote.exe` è¿è¡Œ
          
          ### Microsoft Store ç‰ˆæœ¬ (appx)
          1. ä¸‹è½½ `QLinkNote-${{ steps.get_version.outputs.VERSION }}.appx`
          2. åŒå‡»å®‰è£…æˆ–ä½¿ç”¨ PowerShell: `Add-AppxPackage -Path "QLinkNote-${{ steps.get_version.outputs.VERSION }}.appx"`
          
          ## ğŸ› é—®é¢˜åé¦ˆ
          å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚
          
          ---
          
          **è‡ªåŠ¨æ„å»ºäº**: ${{ github.sha }}
        draft: false
        prerelease: false
        files: |
          release/QLinkNote Setup ${{ steps.get_version.outputs.VERSION }}.exe
          release/QLinkNote-${{ steps.get_version.outputs.VERSION }}.appx
        fail_on_unmatched_files: false
        
    - name: Create portable version
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        
        # æ£€æŸ¥å¯èƒ½çš„ç›®å½•åç§°
        $possibleDirs = @(
          "release\win-unpacked",
          "release\QLinkNote-$VERSION-win-x64-unpacked",
          "release\qlinknote-$VERSION-win-x64-unpacked"
        )
        
        $sourceDir = $null
        foreach ($dir in $possibleDirs) {
          if (Test-Path $dir) {
            $sourceDir = $dir
            Write-Host "æ‰¾åˆ°æºç›®å½•: $sourceDir"
            break
          }
        }
        
        if (-not $sourceDir) {
          Write-Host "åˆ—å‡º release ç›®å½•å†…å®¹:"
          Get-ChildItem -Path "release" -Recurse | Select-Object FullName
          throw "æ‰¾ä¸åˆ° unpacked ç›®å½•"
        }
        
        # åˆ›å»ºä¾¿æºç‰ˆ ZIP
        $zipPath = "release\QLinkNote-win-x64-$VERSION.zip"
        Compress-Archive -Path "$sourceDir\*" -DestinationPath $zipPath -Force
        Write-Host "ä¾¿æºç‰ˆå·²åˆ›å»º: $zipPath"
        
    - name: Upload additional assets
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        files: |
          release/QLinkNote-win-x64-${{ steps.get_version.outputs.VERSION }}.zip
        fail_on_unmatched_files: false
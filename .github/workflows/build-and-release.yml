name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Build Electron app
      run: npm run electron:pack
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: List release files
      run: dir release\
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: QLinkNote ${{ github.ref }}
        body: |
          ğŸ‰ QLinkNote æ–°ç‰ˆæœ¬å‘å¸ƒï¼
          
          ## ğŸ“¦ ä¸‹è½½åœ°å€
          
          ### Windows ç”¨æˆ·
          - **ä¾¿æºç‰ˆ**: ä¸‹è½½ `QLinkNote-Setup-*.exe`
          - **å…å®‰è£…ç‰ˆ**: ä¸‹è½½å¹¶è§£å‹ `QLinkNote-win-x64.zip`
          
          ## ğŸš€ ä¸»è¦ç‰¹æ€§
          - ğŸ“ å®æ—¶ Markdown ç¼–è¾‘å’Œé¢„è§ˆ
          - ğŸ“ å®Œæ•´çš„æ–‡ä»¶ç®¡ç†ç³»ç»Ÿ
          - ğŸ” å¼ºå¤§çš„å…¨æ–‡æœç´¢åŠŸèƒ½
          - ğŸŒ“ æ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢
          - âš¡ ä¸°å¯Œçš„é”®ç›˜å¿«æ·é”®
          - ğŸ’¾ è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
          
          ## ğŸ“‹ å®‰è£…è¯´æ˜
          1. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„å®‰è£…åŒ…
          2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
          3. æŒ‰ç…§å‘å¯¼å®Œæˆå®‰è£…
          4. å¼€å§‹äº«å— Markdown ç¼–è¾‘ä½“éªŒï¼
          
          ## ğŸ› é—®é¢˜åé¦ˆ
          å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/yourusername/qlinknote/issues) ä¸­åé¦ˆã€‚
          
        draft: false
        prerelease: false
        
    - name: Upload Windows Setup
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: release/QLinkNote Setup 1.0.0.exe
        asset_name: QLinkNote-Setup-${{ github.ref_name }}.exe
        asset_content_type: application/octet-stream
        
    - name: Zip Windows portable
      run: |
        cd release/win-unpacked
        7z a ../QLinkNote-win-x64-${{ github.ref_name }}.zip *
        
    - name: Upload Windows Portable
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: release/QLinkNote-win-x64-${{ github.ref_name }}.zip
        asset_name: QLinkNote-win-x64-${{ github.ref_name }}.zip
        asset_content_type: application/zip